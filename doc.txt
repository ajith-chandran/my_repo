import requests
import csv

# --- CONFIG ---
API_TOKEN = "your_token"
PROJECT_KEY = "ServiceMs"
SONAR_URL = "https://url.com"
# --------------

params = {
    "componentKeys": PROJECT_KEY,
    "types": "BUG",
    "statuses": "OPEN",
    "ps": 500  # Increase as needed
}
auth = (API_TOKEN, "")

response = requests.get(f"{SONAR_URL}/api/issues/search", params=params, auth=auth)
data = response.json().get("issues", [])

# Filter only reliability bugs
reliability_issues = []
for issue in data:
    impacts = issue.get("impacts", [])
    if any(impact.get("softwareQuality") == "RELIABILITY" for impact in impacts):
        reliability_issues.append(issue)

# Export to CSV
with open("reliability_issues.csv", "w", newline="") as f:
    writer = csv.writer(f)
    writer.writerow(["Key", "Message", "Severity", "Component", "Line", "Rule"])
    for issue in reliability_issues:
        writer.writerow([
            issue.get("key"),
            issue.get("message"),
            issue.get("severity"),
            issue.get("component"),
            issue.get("line"),
            issue.get("rule")
        ])

